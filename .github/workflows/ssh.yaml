Name: Server Deploy

on: 
  pull_request:
     types: [closed]
     branches:
      - main

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}


jobs:
  deploy-server:
    runs-on: self-hosted
    needs: Terraform CI/CD
    steps:
      - name: Checkout
        uses: actions/Checkout@v2

      - name: SSH to server for deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |-
            ssh -i secrets.SSH_PRIVATE_KEY secrets.USER@secrets.HOST
            cd /home/ubuntu \
            git clone https://github.com/eabrahym75/MERN-store.git 
            cd MERN-store/
            cd backend/
            sudo npm install
            sudo npm install mongodb
            sudo npm run build
            cd ..  \
            cd frontend/     
            sudo yarn install
            sudo yarn run build 
            cd .. \                          
            cd socket/  
            sudo npm install
            sudo npm run build
            cd ..  \
            cd backend/
            # Create a new Nginx site configuration file
            sudo tee /etc/nginx/sites-available/myapp.conf > /dev/null <<EOF
            server {
                listen 80 default_server;
                server_name _;  # Replace with your actual domain or IP address
                      
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                }
              
                location / {
                    proxy_pass http://localhost:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF
              
            # Remove the default Nginx site configuration file
            sudo rm -f /etc/nginx/sites-enabled/default
              
            # Create a symbolic link to enable the new site configuration
            sudo ln -s /etc/nginx/sites-available/myapp.conf /etc/nginx/sites-enabled/
              
            # Test the Nginx configuration for any syntax errors
            sudo nginx -t
              
            # Restart Nginx to apply the new configuration
            sudo systemctl restart nginx
              
            pm2 serve build/ 3000 -f --name "frontend" --spa
              
              
            echo "******************************************"
            echo "Performing the following actions for backend"
            echo "******************************************"
           
            sudo rm -rf build
            sudo npm install
            sudo npm run build
            sudo pm2 delete react-admin || true
            sudo pm2 serve build/ 8000 -f --name "backend" --spa
            sudo systemctl restart nginx
    - name: Remove Github Actions IP from security group
      run: |
        aws ec2 revoke-security-group-ingress --group-id ${{ env.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ env.AWS_REGION }}
      if: always()


